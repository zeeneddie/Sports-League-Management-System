<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports League Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Carousel -->
        <div id="carousel" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner" id="carousel-inner">
                <div class="carousel-item active intro-screen">
                    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                        <h1>Loading Dashboard...</h1>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
        
        <!-- Footer -->
        <div class="screen-footer position-fixed bottom-0 start-0 end-0 p-3 bg-dark text-white">
            <div class="d-flex justify-content-between">
                <div class="screen-number" id="screen-number-display">1/6</div>
                <div class="countdown-timer" id="countdown-display">10</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const SCREEN_DURATION_SECONDS = {{ screen_duration_seconds }};
        
        // Global variables
        let carouselInstance = null;
        let countdownInterval = null;
        let currentCountdown = SCREEN_DURATION_SECONDS;
        let totalSlides = 0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData().then(() => {
                initializeCarousel();
            });
        });

        // Load data from API
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                // Clear existing slides except intro
                const carouselInner = document.getElementById('carousel-inner');
                const introSlide = carouselInner.querySelector('.intro-screen');
                carouselInner.innerHTML = '';
                carouselInner.appendChild(introSlide);
                
                // Add data slides
                addStandingsSlide(data.league_table);
                addPeriodStandingsSlide(data.period_standings);
                addLastWeekResultsSlide(data.last_week_results);
                addNextWeekMatchesSlide(data.next_week_matches);
                addColumbiaMatchesSlide(data.featured_team_matches);
                addTeamMatrixSlide(data.team_matrix);
                
                return data;
            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        // Add slides functions
        function addStandingsSlide(standings) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">League Standings</h2>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>Matches</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${standings.map(team => `
                                <tr>
                                    <td>${team.position}</td>
                                    <td>${team.name}</td>
                                    <td>${team.matches}</td>
                                    <td>${team.points}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        function addPeriodStandingsSlide(periods) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">Period Standings</h2>
                    <div class="row">
                        ${periods.map(period => `
                            <div class="col-md-6 mb-3">
                                <h5>${period.name}</h5>
                                <table class="table table-sm">
                                    <tbody>
                                        ${period.table.slice(0, 5).map(team => `
                                            <tr>
                                                <td>${team.position}</td>
                                                <td>${team.name}</td>
                                                <td>${team.points}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        function addLastWeekResultsSlide(results) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">Last Week Results</h2>
                    <div class="row">
                        ${results.map(result => `
                            <div class="col-md-6 mb-2">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <strong>${result.home} ${result.homeGoals} - ${result.awayGoals} ${result.away}</strong>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        function addNextWeekMatchesSlide(matches) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">Next Week Matches</h2>
                    <div class="row">
                        ${matches.map(match => `
                            <div class="col-md-6 mb-2">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <strong>${match.home} vs ${match.away}</strong>
                                        <br><small>${new Date(match.date).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        function addColumbiaMatchesSlide(matches) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">Columbia Matches</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Played</h5>
                            ${matches.played.map(match => `
                                <div class="mb-2">
                                    <strong>${match.home} ${match.homeGoals} - ${match.awayGoals} ${match.away}</strong>
                                </div>
                            `).join('')}
                        </div>
                        <div class="col-md-6">
                            <h5>Upcoming</h5>
                            ${matches.upcoming.slice(0, 10).map(match => `
                                <div class="mb-2">
                                    <strong>${match.home} vs ${match.away}</strong>
                                    <br><small>${new Date(match.date).toLocaleDateString()}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        function addTeamMatrixSlide(matrix) {
            const slide = document.createElement('div');
            slide.className = 'carousel-item';
            slide.innerHTML = `
                <div class="p-4">
                    <h2 class="text-center mb-4">Team vs Team Matrix</h2>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th></th>
                                    ${Object.keys(matrix).map(team => `<th class="text-center" style="font-size: 0.8em;">${team.substring(0, 8)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(matrix).map(([team, opponents]) => `
                                    <tr>
                                        <th style="font-size: 0.8em;">${team.substring(0, 8)}</th>
                                        ${Object.values(opponents).map(result => `
                                            <td class="text-center" style="font-size: 0.7em;">
                                                ${result ? (result.includes('-') ? result : new Date(result).toLocaleDateString().substring(0, 5)) : '-'}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('carousel-inner').appendChild(slide);
        }

        // Initialize carousel
        function initializeCarousel() {
            const carouselElement = document.getElementById('carousel');
            const slides = carouselElement.querySelectorAll('.carousel-item');
            totalSlides = slides.length;
            
            carouselInstance = new bootstrap.Carousel(carouselElement, {
                interval: false,
                ride: false,
                wrap: true
            });
            
            // Add event listener for slide changes
            carouselElement.addEventListener('slid.bs.carousel', function() {
                updateScreenNumber();
                startCountdown();
            });
            
            updateScreenNumber();
            startCountdown();
        }

        // Countdown functions
        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            currentCountdown = SCREEN_DURATION_SECONDS;
            updateCountdownDisplay();
            
            countdownInterval = setInterval(() => {
                currentCountdown--;
                updateCountdownDisplay();
                
                if (currentCountdown <= 0) {
                    clearInterval(countdownInterval);
                    carouselInstance.next();
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            const element = document.getElementById('countdown-display');
            if (element) {
                element.textContent = currentCountdown;
            }
        }

        function updateScreenNumber() {
            const slides = document.querySelectorAll('.carousel-item');
            let currentIndex = 0;
            
            slides.forEach((slide, index) => {
                if (slide.classList.contains('active')) {
                    currentIndex = index;
                }
            });
            
            const element = document.getElementById('screen-number-display');
            if (element) {
                element.textContent = `${currentIndex + 1}/${totalSlides}`;
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                carouselInstance?.prev();
            } else if (event.key === 'ArrowRight') {
                event.preventDefault();
                carouselInstance?.next();
            }
        });

        // Refresh data every 30 minutes
        setInterval(() => {
            loadData();
        }, 30 * 60 * 1000);

    </script>
</body>
</html>